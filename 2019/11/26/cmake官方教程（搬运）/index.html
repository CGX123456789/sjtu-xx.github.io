<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8" />

<meta name="generator" content="Hexo 4.0.0" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>cmake官方教程（搬运） - 薛轩的个人博客</title>


    <meta name="description" content="原链接 ref 起点（Step 1）参看下面的CMakeLists.txt文件，最简单的一个工程需要有一个这样的cmake文件，一共就这么两行 123cmake_minimum_required (VERSION 2.6)project (Tutorial) add_executable (Tutorial tutorial.cxx)">
<meta name="keywords" content="c++,c,cmake">
<meta property="og:type" content="article">
<meta property="og:title" content="cmake官方教程（搬运）">
<meta property="og:url" content="https:&#x2F;&#x2F;sjtu-xx.github.io&#x2F;2019&#x2F;11&#x2F;26&#x2F;cmake%E5%AE%98%E6%96%B9%E6%95%99%E7%A8%8B%EF%BC%88%E6%90%AC%E8%BF%90%EF%BC%89&#x2F;index.html">
<meta property="og:site_name" content="薛轩的个人博客">
<meta property="og:description" content="原链接 ref 起点（Step 1）参看下面的CMakeLists.txt文件，最简单的一个工程需要有一个这样的cmake文件，一共就这么两行 123cmake_minimum_required (VERSION 2.6)project (Tutorial) add_executable (Tutorial tutorial.cxx)">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;sjtu-xx.github.io&#x2F;images&#x2F;og_image.png">
<meta property="og:updated_time" content="2019-11-26T08:46:00.775Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;sjtu-xx.github.io&#x2F;images&#x2F;og_image.png">







<link rel="icon" href="/images/logo.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
<style>body>.footer,body>.navbar,body>.section{opacity:0}</style>

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">

    
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">

    
    
    
    
<link rel="stylesheet" href="/css/back-to-top.css">

    
    
    
    
    
    
    
    <link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
    
    <script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    


<link rel="stylesheet" href="/css/style.css">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.svg" alt="cmake官方教程（搬运）" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">主页</a>
                
                <a class="navbar-item"
                href="/categories">目录</a>
                
                <a class="navbar-item"
                href="/tags">标签</a>
                
                <a class="navbar-item"
                href="/archives">时间线</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    <a class="navbar-item" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;" target="_blank" rel="noopener">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;" target="_blank" rel="noopener">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-9-widescreen has-order-2 column-main">
<div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-11-26T03:14:47.000Z">2019-11-26</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/c/">c++</a>&nbsp;/&nbsp;<a class="has-link-grey -link" href="/categories/c/cmake/">cmake</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    22 分钟 读完 (大约 3324 个字)
                </span>
                
                
                <span class="level-item has-text-grey" id="busuanzi_container_page_pv">
                    <i class="far fa-eye"></i>
                    <span id="busuanzi_value_page_pv">0</span>次访问
                </span>
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                cmake官方教程（搬运）
            
        </h1>
        <div class="content">
            <p><a href="https://www.jianshu.com/p/6df3857462cd" target="_blank" rel="noopener">原链接 ref</a></p>
<h2 id="起点（Step-1）"><a href="#起点（Step-1）" class="headerlink" title="起点（Step 1）"></a>起点（Step 1）</h2><p>参看下面的CMakeLists.txt文件，最简单的一个工程需要有一个这样的cmake文件，一共就这么两行</p>
<figure class="highlight css hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-selector-tag">cmake_minimum_required</span> (<span class="hljs-selector-tag">VERSION</span> 2<span class="hljs-selector-class">.6</span>)</span><br><span class="line"><span class="hljs-selector-tag">project</span> (<span class="hljs-selector-tag">Tutorial</span>) </span><br><span class="line"><span class="hljs-selector-tag">add_executable</span> (<span class="hljs-selector-tag">Tutorial</span> <span class="hljs-selector-tag">tutorial</span><span class="hljs-selector-class">.cxx</span>)</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>注意到这里都是用的小写的命令，在cmake文件里面大小写不严格区分，都可以用。<br> add_executable添加一个可编译的目标到工程里面</p>
<figure class="highlight css hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-selector-tag">add_executable</span>(&lt;<span class="hljs-selector-tag">name</span>&gt; <span class="hljs-selector-attr">[WIN32]</span> <span class="hljs-selector-attr">[MACOSX_BUNDLE]</span></span><br><span class="line">               <span class="hljs-selector-attr">[EXCLUDE_FROM_ALL]</span></span><br><span class="line">               <span class="hljs-selector-tag">source1</span> <span class="hljs-selector-attr">[source2 ...]</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>name: 工程所要构建的目标名称</li>
<li>WIN32/..: 目标app运行的平台</li>
<li>source1：构建目标App的源文件</li>
</ul>
<p>tutorial.cxx的源代码计算一个数的平方根。第一版的代码很简单，参看如下：</p>
<figure class="highlight cpp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// A simple program that computes the square root of a number</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span> <span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>, <span class="hljs-string">"Uage: %s number\n"</span>, argv[<span class="hljs-number">0</span>]);</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">double</span> inputValue = atof(argv[<span class="hljs-number">1</span>]);</span><br><span class="line">  <span class="hljs-keyword">double</span> outputValue = <span class="hljs-built_in">sqrt</span>(inputValue);</span><br><span class="line">  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>, <span class="hljs-string">"The square root of %g is %g\n"</span>,</span><br><span class="line">            inputValue, outputValue);</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写完上面两个文件以后，在根目录下新建一个build目录<br> .<br> ├── build<br> ├── CMakeLists.txt<br> └── tutorial.cxx<br> 然后运行如下命令</p>
<figure class="highlight ruby hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cd buld</span><br><span class="line">$ CMake ..</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure>

<ul>
<li>CMake会自动加载上级目录里面的CMakeLists.txt文件，编译所需的文件都会生成在build目录下</li>
<li>make之后会生成可执行文件Tutorial</li>
</ul>
<h3 id="添加一个版本号和配置的头文件"><a href="#添加一个版本号和配置的头文件" class="headerlink" title="添加一个版本号和配置的头文件"></a>添加一个版本号和配置的头文件</h3><p>修改CMakeList.txt来添加version number：</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required (VERSION 2.6)</span><br><span class="line">project (Tutorial)</span><br><span class="line"><span class="hljs-comment"># 版本号.</span></span><br><span class="line"><span class="hljs-built_in">set</span> (Tutorial_VERSION_MAJOR 1)</span><br><span class="line"><span class="hljs-built_in">set</span> (Tutorial_VERSION_MINOR 0)</span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment"># 配置一个头文件来传递一些CMake设置到源代码</span></span><br><span class="line">configure_file (</span><br><span class="line">  <span class="hljs-string">"<span class="hljs-variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/TutorialConfig.h.in"</span></span><br><span class="line">  <span class="hljs-string">"<span class="hljs-variable">$&#123;PROJECT_BINARY_DIR&#125;</span>/TutorialConfig.h"</span></span><br><span class="line">  )</span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment"># 添加TutorialConfig.h的路径到头文件的搜索路径</span></span><br><span class="line">include_directories(<span class="hljs-string">"<span class="hljs-variable">$&#123;PROJECT_BINARY_DIR&#125;</span>"</span>)</span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment"># 添加目标可执行文件</span></span><br><span class="line">add_executable(Tutorial tutorial.cxx)</span><br></pre></td></tr></table></figure>

<p>configure_file会拷贝一个文件到另一个目录并修改文件内容:</p>
<figure class="highlight css hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-selector-tag">configure_file</span>(&lt;<span class="hljs-selector-tag">input</span>&gt; &lt;<span class="hljs-selector-tag">output</span>&gt;</span><br><span class="line">               <span class="hljs-selector-attr">[COPYONLY]</span> <span class="hljs-selector-attr">[ESCAPE_QUOTES]</span> <span class="hljs-selector-attr">[@ONLY]</span></span><br><span class="line">               <span class="hljs-selector-attr">[NEWLINE_STYLE [UNIX|DOS|WIN32|LF|CRLF]</span> ])</span><br></pre></td></tr></table></figure>

<p>cmake会自动定义两个变量</p>
<ul>
<li>${PROJECT_SOURCE_DIR}：  当前工程最上层的目录</li>
<li>${PROJECT_BINARY_DIR}：　当前工程的构建目录（本例中新建的build目录）</li>
</ul>
<p>在这个例子里，configure_file命令的源文件是TutorialConfig.h.in，手动创建这个文件：</p>
<figure class="highlight cpp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// Tutorial工程的配置选项和设置</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> Tutorial_VERSION_MAJOR @Tutorial_VERSION_MAJOR@</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> Tutorial_VERSION_MINOR @Tutorial_VERSION_MINOR@</span></span><br></pre></td></tr></table></figure>

<p>调用CMake的时候会在build目录下新的头文件，并且使用CMakeList.txt中定义的值来替换@Tutorial_VERSION_MAJOR@和@Tutorial_VERSION_MINOR@这两个变量。<br> 下一步要在源文件tutorial.cxx中包含这个配置的头文件，就能使用这些版本信息了。</p>
<figure class="highlight cpp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// A simple program that computes the square root of a number</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"TutorialConfig.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span> <span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>, <span class="hljs-string">"%s Version %d.%d\n"</span>, </span><br><span class="line">              argv[<span class="hljs-number">0</span>],</span><br><span class="line">              Tutorial_VERSION_MAJOR,</span><br><span class="line">              Tutorial_VERSION_MINOR)</span><br><span class="line">    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>, <span class="hljs-string">"Uage: %s number\n"</span>, argv[<span class="hljs-number">0</span>]);</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">double</span> inputValue = atof(argv[<span class="hljs-number">1</span>]);</span><br><span class="line">  <span class="hljs-keyword">double</span> outputValue = <span class="hljs-built_in">sqrt</span>(inputValue);</span><br><span class="line">  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>, <span class="hljs-string">"The square root of %g is %g\n"</span>,</span><br><span class="line">            inputValue, outputValue);</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行如下命令查看结果</p>
<figure class="highlight ruby hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cmake ..</span><br><span class="line">$ make</span><br><span class="line">$ ./Tutorial</span><br></pre></td></tr></table></figure>

<p>这个时候控制台会打印出来版本号</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./Tutorial Version 1.0</span><br><span class="line">Uage: ./Tutorial number</span><br></pre></td></tr></table></figure>

<h2 id="添加Library（Step-2）"><a href="#添加Library（Step-2）" class="headerlink" title="添加Library（Step 2）"></a>添加Library（Step 2）</h2><p>现在我们尝试添加一个library到我们的工程。这个lib提供一个自定义的计算平方根的函数，用来替换编译器提供的函数。<br> lib的源文件放到一个叫MathFunctions的子目录中，在目录下新建CMakeList.txt文件，添加如下的一行</p>
<figure class="highlight css hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-selector-tag">add_library</span>(<span class="hljs-selector-tag">MathFunctions</span> <span class="hljs-selector-tag">mysqrt</span><span class="hljs-selector-class">.cxx</span>)</span><br></pre></td></tr></table></figure>

<p>源文件mysqrt.cxx包含一个函数mysqrt用于计算平方根。代码如下</p>
<figure class="highlight cpp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"MathFunctions.h"</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment">// a hack square root calculation using simple operations</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">double</span> <span class="hljs-title">mysqrt</span><span class="hljs-params">(<span class="hljs-keyword">double</span> x)</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (x &lt;= <span class="hljs-number">0</span>) &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-keyword">double</span> result;</span><br><span class="line">  <span class="hljs-keyword">double</span> delta;</span><br><span class="line">  result = x;</span><br><span class="line"></span><br><span class="line">  <span class="hljs-comment">// do ten iterations</span></span><br><span class="line">  <span class="hljs-keyword">int</span> i;</span><br><span class="line">  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; ++i) &#123;</span><br><span class="line">    <span class="hljs-keyword">if</span> (result &lt;= <span class="hljs-number">0</span>) &#123;</span><br><span class="line">      result = <span class="hljs-number">0.1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    delta = x - (result * result);</span><br><span class="line">    result = result + <span class="hljs-number">0.5</span> * delta / result;</span><br><span class="line">    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>, <span class="hljs-string">"Computing sqrt of %g to be %g\n"</span>, x, result);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="hljs-keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还需要添加一个头文件MathFunctions.h以提供接口给main函数调用</p>
<figure class="highlight cpp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">double</span> <span class="hljs-title">mysqrt</span><span class="hljs-params">(<span class="hljs-keyword">double</span> x)</span></span>;</span><br></pre></td></tr></table></figure>

<p>现在的目录结构<br> .<br> ├── build<br> ├── CMakeLists.txt<br> ├── MathFunctions<br> │   ├── CMakeLists.txt<br> │   ├── MathFunctions.h<br> │   └── mysqrt.cxx<br> ├── TutorialConfig.h.in<br> └── tutorial.cxx</p>
<p>CMakeLists.txt文件需要相应做如下改动</p>
<ul>
<li>添加一行add_subdirectory来保证新加的library在工程构建过程中被编译。</li>
<li>添加新的头文件搜索路径MathFunction/MathFunctions.h。</li>
<li>添加新的library到executable。</li>
</ul>
<p>CMakeList.txt的最后几行变成了这样：</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">include_directories (<span class="hljs-string">"<span class="hljs-variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/MathFunctions"</span>)</span><br><span class="line">add_subdirectory (MathFunctions)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># 添加executable</span></span><br><span class="line">add_executable (Tutorial tutorial.cxx)</span><br><span class="line">target_link_libraries (Turorial MathFunctions)</span><br></pre></td></tr></table></figure>

<p>最后要修改tutorial.cxx文件来调用自定义的mysqrt函数<br> 最后编译一下试试</p>
<figure class="highlight ruby hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cmake ..</span><br><span class="line">$ make</span><br><span class="line">$ ./Tutorial</span><br></pre></td></tr></table></figure>

<p>看一下编译的log</p>
<figure class="highlight csharp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Scanning dependencies of target MathFunctions</span><br><span class="line">[<span class="hljs-meta"> 50%</span>] Building CXX <span class="hljs-keyword">object</span> MathFunctions/CMakeFiles/MathFunctions.dir/mysqrt.cxx.o</span><br><span class="line">Linking CXX <span class="hljs-keyword">static</span> library libMathFunctions.a</span><br><span class="line">[<span class="hljs-meta"> 50%</span>] Built target MathFunctions</span><br><span class="line">Scanning dependencies of target Tutorial</span><br><span class="line">[<span class="hljs-meta">100%</span>] Building CXX <span class="hljs-keyword">object</span> CMakeFiles/Tutorial.dir/tutorial.cxx.o</span><br><span class="line">Linking CXX executable Tutorial</span><br><span class="line">[<span class="hljs-meta">100%</span>] Built target Tutorial</span><br></pre></td></tr></table></figure>

<p>这里编译生成了新的库libMathFunctions.a</p>
<h3 id="现在我们考虑把MathFunctions库配置成可选的"><a href="#现在我们考虑把MathFunctions库配置成可选的" class="headerlink" title="现在我们考虑把MathFunctions库配置成可选的"></a>现在我们考虑把MathFunctions库配置成可选的</h3><p>首先在最顶层的CMakeList.txt文件添加一个option</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#需要用自定义的数学函数么？</span></span><br><span class="line">option (USE_MYMATH</span><br><span class="line">            <span class="hljs-string">"Use tutorial provided math implementation"</span> ON)</span><br></pre></td></tr></table></figure>

<p>运行ccmake ..会跳出来配置的GUI，在GUi中会看到新添加的这个选项，用户可以根据需要进行修改。<br> 下一个改变是依据配置来判断是否编译和链接MathFunctions库。按照如下所示的修改CMakeList.txt的末尾几行：</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># add the MathFunctions library?</span></span><br><span class="line"><span class="hljs-keyword">if</span> (USE_MYMATH)</span><br><span class="line">  include_directories (<span class="hljs-string">"<span class="hljs-variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/MathFunctions"</span>)</span><br><span class="line">  add_subdirectory (MathFunctions)</span><br><span class="line">  SET (EXTRA_LIBS <span class="hljs-variable">$&#123;EXTRA_LIBS&#125;</span> MathFunctions)</span><br><span class="line">endif (USE_MYMATH)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># add executable</span></span><br><span class="line">add_executable (Tutorial tutorial.cxx)</span><br><span class="line">target_link_libraries (Turorial <span class="hljs-variable">$&#123;EXTRA_LIBS&#125;</span>)</span><br></pre></td></tr></table></figure>

<p>这个例子里还是用了变量（EXTRA_LIBS）来收集后面link进可执行文件的时候任意可选的库。这是一个常用的方法，在工程非常大有很多optional的组件的时候，可以让这个编译文件保持干净。<br> 代码的修改就更直接了(用宏定义隔离开)：</p>
<figure class="highlight cpp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// A simple program that computes the square root of a number</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"TutorialConfig.h"</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> USE_MYMATH</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"MathFunctions.h"</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span><br><span class="line"> </span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span> <span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">  <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>,<span class="hljs-string">"%s Version %d.%d\n"</span>, argv[<span class="hljs-number">0</span>],</span><br><span class="line">            Tutorial_VERSION_MAJOR,</span><br><span class="line">            Tutorial_VERSION_MINOR);</span><br><span class="line">    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>,<span class="hljs-string">"Usage: %s number\n"</span>,argv[<span class="hljs-number">0</span>]);</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="hljs-keyword">double</span> inputValue = atof(argv[<span class="hljs-number">1</span>]);</span><br><span class="line"> </span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> USE_MYMATH</span></span><br><span class="line">  <span class="hljs-keyword">double</span> outputValue = mysqrt(inputValue);</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span></span><br><span class="line">  <span class="hljs-keyword">double</span> outputValue = <span class="hljs-built_in">sqrt</span>(inputValue);</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></span><br><span class="line"> </span><br><span class="line">  <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>,<span class="hljs-string">"The square root of %g is %g\n"</span>,</span><br><span class="line">          inputValue, outputValue);</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在源代码里面同样可以使用USE_MYMATH，只要在TutorialConfig.h.in里面添加一行</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#cmakedefine USE_MYMATH</span></span><br></pre></td></tr></table></figure>

<h2 id="安装测试-Step-3"><a href="#安装测试-Step-3" class="headerlink" title="安装测试 (Step 3)"></a>安装测试 (Step 3)</h2><p>下一步我们会添加install规则和testing到工程。install规则非常直接。对于MathFunctions库，我们通过在MathFunctions的CMakeList文件中添加如下两行来安装库和头文件。</p>
<figure class="highlight css hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-selector-tag">install</span> (<span class="hljs-selector-tag">TARGETS</span> <span class="hljs-selector-tag">MathFunctions</span> <span class="hljs-selector-tag">DESTINATION</span> <span class="hljs-selector-tag">bin</span>)</span><br><span class="line"><span class="hljs-selector-tag">install</span>(<span class="hljs-selector-tag">FILES</span> <span class="hljs-selector-tag">MathFunctions</span><span class="hljs-selector-class">.h</span> <span class="hljs-selector-tag">DESTINATION</span> <span class="hljs-selector-tag">include</span>)</span><br></pre></td></tr></table></figure>

<p>对于应用程序，为了安装executable和配置头文件，需要在最上层的CMakeList.txt文件中添加下面几行</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># add the install targets</span></span><br><span class="line">install (TARGETS Tutorial DESTINATION bin)</span><br><span class="line">install (FILES <span class="hljs-string">"<span class="hljs-variable">$&#123;PROJECT_BINARY_DIR&#125;</span>/TutorialConfig.h"</span> DESTINATION include)</span><br></pre></td></tr></table></figure>

<p>到了这里你就可以构建整个tutorial了，通过命令make install，系统会自动安装对应的头文件，库以及可执行文件。CMake变量CMAKE_INSTALL_PREFIX用来指定这些文件需要安装到哪个根目录。<br> 添加测试用例也很直接，只要在最上层的CMakeList.txt文件添加一系列的基础测试来验证应用程序是否正常工作。</p>
<figure class="highlight php hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">include</span>(CTest)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># does the application run</span></span><br><span class="line">add_test (TutorialRuns Tutorial <span class="hljs-number">25</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># does it sqrt of 25</span></span><br><span class="line">add_test (TutorialComp25 Tutorial <span class="hljs-number">25</span>)</span><br><span class="line">set_tests_properties (TutorialComp25 PROPERTIES PASS_REGULAR_EXPRESSION <span class="hljs-string">"25 is 5"</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># does it handle negative numbers</span></span><br><span class="line">add_test (TutorialNegative Tutorial <span class="hljs-number">-25</span>)</span><br><span class="line">set_tests_properties (TutorialNegative PROPERTIES PASS_REGULAR_EXPRESSION <span class="hljs-string">"-25 is 0"</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># does it handle small numbers</span></span><br><span class="line">add_test (TutorialSmall Tutorial <span class="hljs-number">0.0001</span>)</span><br><span class="line">set_tests_properties (TutorialSmall PROPERTIES PASS_REGULAR_EXPRESSION <span class="hljs-string">"0.0001 is 0.01"</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># does the usage message work?</span></span><br><span class="line">add_test (TutorialUsage Tutorial)</span><br><span class="line">set_tests_properties (TutorialUsage PROPERTIES PASS_REGULAR_EXPRESSION <span class="hljs-string">"Usage:.*number"</span>)</span><br></pre></td></tr></table></figure>

<p>编译完成后可以通过在命令行运行ctest来执行这些测试用例。如果你希望添加很多测试用例来测试不同的输入值，这个时候推荐你创建一个宏，这样添加新的case会更轻松：</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">#define a macro to simplify adding tests, then use it</span></span><br><span class="line">macro (do_test arg result)</span><br><span class="line">  add_test (TutorialComp<span class="hljs-variable">$&#123;arg&#125;</span> Tutorial <span class="hljs-variable">$&#123;arg&#125;</span>)</span><br><span class="line">  set_tests_properties (TutorialComp<span class="hljs-variable">$&#123;arg&#125;</span></span><br><span class="line">    PROPERTIES PASS_REGULAR_EXPRESSION <span class="hljs-variable">$&#123;result&#125;</span>)</span><br><span class="line">endmacro (do_test)</span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment"># do a bunch of result based tests</span></span><br><span class="line">do_test (25 <span class="hljs-string">"25 is 5"</span>)</span><br><span class="line">do_test (-25 <span class="hljs-string">"-25 is 0"</span>)</span><br></pre></td></tr></table></figure>

<p>每次调用do_test，都会添加一个新的test case到工程。</p>
<h2 id="添加系统回顾-Step-4"><a href="#添加系统回顾-Step-4" class="headerlink" title="添加系统回顾 (Step 4)"></a>添加系统回顾 (Step 4)</h2><p>下一步我们考虑在工程中添加一些代码，这些代码会依赖的某些特性在运行的目标平台上可能没有。比如说，我们添加了一些代码，这些代码需要用到log和exp函数，但某些目标平台上可能没有这些库函数。如果平台有log函数那么我们就是用log来计算平方根，我们首先通过CheckFunctionExists.cmake来测试一下是否有这些函数，在最上层的CMakeList文件中添加如下内容</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># does this system provide the log and exp functions?</span><br><span class="line">include (CheckFunctionExists)</span><br><span class="line">check_function_exists (log HAVE_LOG)</span><br><span class="line">check_function_exists (exp HAVE_EXP)</span><br></pre></td></tr></table></figure>

<p>Next we modify the TutorialConfig.h.in to define those values if CMake found them on the platform as follows:<br> 下一步，如果CMake发现平台有我们需要的这些函数，则需要修改TutorialConfig.h.in来定义这些值</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// does the platform provide exp and <span class="hljs-built_in">log</span> <span class="hljs-built_in">functions</span>?</span><br><span class="line"><span class="hljs-comment">#cmakedefine HAVE_LOG</span></span><br><span class="line"><span class="hljs-comment">#cmakedefine HAVE_EXP</span></span><br></pre></td></tr></table></figure>

<p>有一点很重要，就是log和exp的测试工作需要在配置TutorialConfig.h前完成。最后在mysqrt函数中我们可以提供一个可选的实现方式：</p>
<figure class="highlight cpp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// if we have both log and exp then use them</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined (HAVE_LOG) &amp;&amp; defined (HAVE_EXP)</span></span><br><span class="line">  result = <span class="hljs-built_in">exp</span>(<span class="hljs-built_in">log</span>(x)*<span class="hljs-number">0.5</span>);</span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">else</span> <span class="hljs-comment">// otherwise use an iterative approach</span></span></span><br><span class="line">  . . .</span><br></pre></td></tr></table></figure>

<h2 id="添加生成文件和生成器-Step-5"><a href="#添加生成文件和生成器-Step-5" class="headerlink" title="添加生成文件和生成器 (Step 5)"></a>添加生成文件和生成器 (Step 5)</h2><p>这一节中我们会演示一下怎么添加一个生成的源文件到引用程序的构建过程中。例如说，我们希望在构建过程中创建一个预先计算好的平方根表，然后把这个表格编译进我们的应用程序。首先我们需要一个能生成这张表的程序。在MathFunctions子目录中，定义一个新的源文件MakeTable.cxx:</p>
<figure class="highlight cpp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// A simple program that builds a sqrt table </span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span> <span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="hljs-function"></span>&#123;</span><br><span class="line">  <span class="hljs-keyword">int</span> i;</span><br><span class="line">  <span class="hljs-keyword">double</span> result;</span><br><span class="line"> </span><br><span class="line">  <span class="hljs-comment">// make sure we have enough arguments</span></span><br><span class="line">  <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="hljs-comment">// open the output file</span></span><br><span class="line">  FILE *fout = fopen(argv[<span class="hljs-number">1</span>],<span class="hljs-string">"w"</span>);</span><br><span class="line">  <span class="hljs-keyword">if</span> (!fout)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="hljs-comment">// create a source file with a table of square roots</span></span><br><span class="line">  <span class="hljs-built_in">fprintf</span>(fout,<span class="hljs-string">"double sqrtTable[] = &#123;\n"</span>);</span><br><span class="line">  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">    result = <span class="hljs-built_in">sqrt</span>(<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">double</span>&gt;(i));</span><br><span class="line">    <span class="hljs-built_in">fprintf</span>(fout,<span class="hljs-string">"%g,\n"</span>,result);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="hljs-comment">// close the table with a zero</span></span><br><span class="line">  <span class="hljs-built_in">fprintf</span>(fout,<span class="hljs-string">"0&#125;;\n"</span>);</span><br><span class="line">  fclose(fout);</span><br><span class="line">  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意到这里的需要传递正确的输出文件给app，然后才会生成table。下一步是在MathFunctions的CMakeList.txt添加相应的命令来编译生成可执行文件MakeTable，然后在编译过程中运行这个程序。如下所示的添加一些命令：</p>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># first we add the executable that generates the table</span></span><br><span class="line">add_executable(MakeTable MakeTable.cxx)</span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment"># add the command to generate the source code</span></span><br><span class="line">add_custom_command (</span><br><span class="line">  OUTPUT <span class="hljs-variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/Table.h</span><br><span class="line">  COMMAND MakeTable <span class="hljs-variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/Table.h</span><br><span class="line">  DEPENDS MakeTable</span><br><span class="line">  )</span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment"># add the binary tree directory to the search path for </span></span><br><span class="line"><span class="hljs-comment"># include files</span></span><br><span class="line">include_directories( <span class="hljs-variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span> )</span><br><span class="line"> </span><br><span class="line"><span class="hljs-comment"># add the main library</span></span><br><span class="line">add_library(MathFunctions mysqrt.cxx <span class="hljs-variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/Table.h  )</span><br></pre></td></tr></table></figure>

<ul>
<li>首先添加可执行的MakeTable。</li>
<li>然后我们添加一个用户命令指定怎么通过允许MakeTable来生成Table.h。</li>
<li>下一步需要让CMAKE知道mysqrt.cxx依赖生成的Table.h。把生成的Table.h添加到MathFunctions库的资源列表中。</li>
<li>还需要添加当前的bin的目录添加到include的list中，这样mysqrt.cxx编译时候可以找到Table.h。</li>
<li>最后编译包含Table.h的mysqrt.cxx来生成MathFunctions库<br> 到这儿最上层的CMakeList.txt文件就如下面所示：</li>
</ul>
<figure class="highlight bash hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required (VERSION 2.6)</span><br><span class="line">project (Tutorial)</span><br><span class="line"></span><br><span class="line">include(CTest) </span><br><span class="line"><span class="hljs-comment"># The version number.</span></span><br><span class="line"><span class="hljs-built_in">set</span> (Tutorial_VERSION_MAJOR 1)</span><br><span class="line"><span class="hljs-built_in">set</span> (Tutorial_VERSION_MINOR 0) </span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># does this system provide the log and exp functions?</span></span><br><span class="line">include (<span class="hljs-variable">$&#123;CMAKE_ROOT&#125;</span>/Modules/CheckFunctionExists.cmake) check_function_exists (<span class="hljs-built_in">log</span> HAVE_LOG)</span><br><span class="line">check_function_exists (exp HAVE_EXP) </span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># should we use our own math functions</span></span><br><span class="line">option(USE_MYMATH <span class="hljs-string">"Use tutorial provided math implementation"</span> ON) </span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># configure a header file to pass some of the CMake settings</span></span><br><span class="line"><span class="hljs-comment"># to the source code</span></span><br><span class="line">configure_file ( <span class="hljs-string">"<span class="hljs-variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/TutorialConfig.h.in"</span> <span class="hljs-string">"<span class="hljs-variable">$&#123;PROJECT_BINARY_DIR&#125;</span>/TutorialConfig.h"</span> ) </span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># add the binary tree to the search path for include files</span></span><br><span class="line"><span class="hljs-comment"># so that we will find TutorialConfig.h</span></span><br><span class="line">include_directories (<span class="hljs-string">"<span class="hljs-variable">$&#123;PROJECT_BINARY_DIR&#125;</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># add the MathFunctions library?</span></span><br><span class="line"><span class="hljs-keyword">if</span> (USE_MYMATH) </span><br><span class="line">  include_directories (<span class="hljs-string">"<span class="hljs-variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/MathFunctions"</span>)</span><br><span class="line">  add_subdirectory (MathFunctions) </span><br><span class="line">  <span class="hljs-built_in">set</span> (EXTRA_LIBS <span class="hljs-variable">$&#123;EXTRA_LIBS&#125;</span> MathFunctions)</span><br><span class="line">endif (USE_MYMATH) </span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># add the executable</span></span><br><span class="line">add_executable (Tutorial tutorial.cxx)</span><br><span class="line">target_link_libraries (Tutorial <span class="hljs-variable">$&#123;EXTRA_LIBS&#125;</span>) </span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># add the install targets</span></span><br><span class="line">install (TARGETS Tutorial DESTINATION bin)</span><br><span class="line">install (FILES <span class="hljs-string">"<span class="hljs-variable">$&#123;PROJECT_BINARY_DIR&#125;</span>/TutorialConfig.h"</span> DESTINATION include) </span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># does the application run</span></span><br><span class="line">add_test (TutorialRuns Tutorial 25) </span><br><span class="line"><span class="hljs-comment"># does the usage message work?</span></span><br><span class="line">add_test (TutorialUsage Tutorial)</span><br><span class="line">set_tests_properties (TutorialUsage PROPERTIES PASS_REGULAR_EXPRESSION <span class="hljs-string">"Usage:.*number"</span> ) </span><br><span class="line"><span class="hljs-comment">#define a macro to simplify adding tests</span></span><br><span class="line">macro (do_test arg result) </span><br><span class="line">  add_test (TutorialComp<span class="hljs-variable">$&#123;arg&#125;</span> Tutorial <span class="hljs-variable">$&#123;arg&#125;</span>) </span><br><span class="line">  set_tests_properties (TutorialComp<span class="hljs-variable">$&#123;arg&#125;</span> PROPERTIES PASS_REGULAR_EXPRESSION <span class="hljs-variable">$&#123;result&#125;</span> )</span><br><span class="line">endmacro (do_test) </span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># do a bunch of result based tests</span></span><br><span class="line">do_test (4 <span class="hljs-string">"4 is 2"</span>)</span><br><span class="line">do_test (9 <span class="hljs-string">"9 is 3"</span>)</span><br><span class="line">do_test (5 <span class="hljs-string">"5 is 2.236"</span>)</span><br><span class="line">do_test (7 <span class="hljs-string">"7 is 2.645"</span>)</span><br><span class="line">do_test (25 <span class="hljs-string">"25 is 5"</span>)</span><br><span class="line">do_test (-25 <span class="hljs-string">"-25 is 0"</span>)</span><br><span class="line">do_test (0.0001 <span class="hljs-string">"0.0001 is 0.01"</span>)</span><br></pre></td></tr></table></figure>

<p>TutorialConfig.h.in 文件如下:</p>
<figure class="highlight cpp hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment">// the configured options and settings for Tutorial</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> Tutorial_VERSION_MAJOR @Tutorial_VERSION_MAJOR@</span></span><br><span class="line"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> Tutorial_VERSION_MINOR @Tutorial_VERSION_MINOR@</span></span><br><span class="line"><span class="hljs-meta">#cmakedefine USE_MYMATH </span></span><br><span class="line"><span class="hljs-comment">// does the platform provide exp and log functions?</span></span><br><span class="line"><span class="hljs-meta">#cmakedefine HAVE_LOG</span></span><br><span class="line"><span class="hljs-meta">#cmakedefine HAVE_EXP</span></span><br></pre></td></tr></table></figure>

<p>MathFunctions的文件CMakeLists.txt如下:</p>
<figure class="highlight ruby hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># first we add the executable that generates the table</span></span><br><span class="line">add_executable(MakeTable MakeTable.cxx)</span><br><span class="line"><span class="hljs-comment"># add the command to generate the source code</span></span><br><span class="line">add_custom_command ( OUTPUT $&#123;CMAKE_CURRENT_BINARY_DIR&#125;/Table.h DEPENDS MakeTable COMMAND MakeTable $&#123;CMAKE_CURRENT_BINARY_DIR&#125;/Table.h )</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># add the binary tree directory to the search path </span></span><br><span class="line"><span class="hljs-comment"># for include files</span></span><br><span class="line">include_directories( $&#123;CMAKE_CURRENT_BINARY_DIR&#125; ) </span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># add the main library</span></span><br><span class="line">add_library(MathFunctions mysqrt.cxx $&#123;CMAKE_CURRENT_BINARY_DIR&#125;/Table.h) </span><br><span class="line">install (TARGETS MathFunctions DESTINATION bin)</span><br><span class="line">install (FILES MathFunctions.h DESTINATION <span class="hljs-keyword">include</span>)</span><br></pre></td></tr></table></figure>



        </div>
        
            <ul class="post-copyright">
            <li><strong>本文标题：</strong><a href="https://sjtu-xx.github.io/2019/11/26/cmake%E5%AE%98%E6%96%B9%E6%95%99%E7%A8%8B%EF%BC%88%E6%90%AC%E8%BF%90%EF%BC%89/">cmake官方教程（搬运）</a></li>
            <li><strong>本文作者：</strong><a href="https://sjtu-xx.github.io">Xue Xuan</a></li>
            <li><strong>本文链接：</strong><a href="https://sjtu-xx.github.io/2019/11/26/cmake%E5%AE%98%E6%96%B9%E6%95%99%E7%A8%8B%EF%BC%88%E6%90%AC%E8%BF%90%EF%BC%89/">https://sjtu-xx.github.io/2019/11/26/cmake%E5%AE%98%E6%96%B9%E6%95%99%E7%A8%8B%EF%BC%88%E6%90%AC%E8%BF%90%EF%BC%89/</a></li>
            <li><strong>发布时间：</strong>2019-11-26</li>
            <li><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！
            </li>
        </ul>
        
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/c/" rel="tag">c</a>, <a class="has-link-grey -link" href="/tags/c/" rel="tag">c++</a>, <a class="has-link-grey -link" href="/tags/cmake/" rel="tag">cmake</a>
                </div>
            </div>
        </div>
        
        
        
        <div class="social-share"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css">
<script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3>
        <div class="buttons is-centered">
            
                
<a class="button is-info donate">
    <span class="icon is-small">
        <i class="fab fa-alipay"></i>
    </span>
    <span>支付宝</span>
    <div class="qrcode"><img src="/images/alipay.jpg" alt="支付宝"></div>
</a>

                
        </div>
    </div>
</div>



<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2019/11/26/cmake%E5%9F%BA%E7%A1%80%EF%BC%88%E6%90%AC%E8%BF%90%EF%BC%89/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">cmake基础（搬运）</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2019/11/25/mac%E4%B8%8B%E7%9A%84c-%E5%BA%93%E5%AE%89%E8%A3%85/">
                <span class="level-item">mac下的c++库安装</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>


</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
    
        

    <div class="card widget" id="toc">
        <div class="card-content">
            <div class="menu">
                <h3 class="menu-label">
                    目录
                </h3>
                <ul class="menu-list"><li>
        <a class="is-flex" href="#起点（Step-1）">
        <span class="has-mr-6">1</span>
        <span>起点（Step 1）</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#添加一个版本号和配置的头文件">
        <span class="has-mr-6">1.1</span>
        <span>添加一个版本号和配置的头文件</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#添加Library（Step-2）">
        <span class="has-mr-6">2</span>
        <span>添加Library（Step 2）</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#现在我们考虑把MathFunctions库配置成可选的">
        <span class="has-mr-6">2.1</span>
        <span>现在我们考虑把MathFunctions库配置成可选的</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#安装测试-Step-3">
        <span class="has-mr-6">3</span>
        <span>安装测试 (Step 3)</span>
        </a></li><li>
        <a class="is-flex" href="#添加系统回顾-Step-4">
        <span class="has-mr-6">4</span>
        <span>添加系统回顾 (Step 4)</span>
        </a></li><li>
        <a class="is-flex" href="#添加生成文件和生成器-Step-5">
        <span class="has-mr-6">5</span>
        <span>添加生成文件和生成器 (Step 5)</span>
        </a></li></ul>
            </div>
        </div>
    </div>

    
    
        <div class="column-right-shadow is-hidden-widescreen ">
        
        </div>
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
<!--     <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile"> -->
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.svg" alt="cmake官方教程（搬运）" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2019 Xue Xuan&nbsp;
                
                <br>
                <span id="busuanzi_container_site_uv"> 来访 <span id="busuanzi_value_site_uv"></span>人</span>
                <span id="busuanzi_container_site_pv">, 总访问 <span id="busuanzi_value_site_pv"></span>次</span>

                </span>
                
                </p>
            <!-- </div> -->
            <!-- <div class="level-end">
            
            </div> -->
<!--         </div>
    </div> -->
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>

<script>
var IcarusThemeSettings = {
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>



    
    
<script src="/js/animation.js"></script>

    
    
<script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
<script src="/js/gallery.js" defer></script>

    
    
<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/" target="_blank" rel="noopener">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>

    
    <script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>
    
    
<a target="_self" id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>

    
    
    
    
    
    
    
    
    
    
    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>